<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理面板</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
        }
        #app {
            max-width: 1200px;
            margin: 20px auto;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 30px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        h2 {
            color: #34495e;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-top: 30px;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab-button {
            background-color: #ecf0f1;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            color: #7f8c8d;
            transition: background-color 0.3s, color 0.3s;
            border-radius: 8px 8px 0 0;
            margin: 0 5px;
        }
        .tab-button:hover {
            background-color: #dfe6e9;
        }
        .tab-button.active {
            background-color: #3498db;
            color: #fff;
            border-bottom: 2px solid #3498db;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .tab-content {
            display: none;
            padding: 20px 0;
        }
        .tab-content.active {
            display: block;
        }
        #status-message {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #status-message.show {
            opacity: 1;
        }
        #status-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        #status-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        #status-message.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"],
        textarea,
        select {
            width: calc(100% - 22px);
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            border-color: #3498db;
            outline: none;
        }
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            margin-right: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .delete-button {
            background-color: #e74c3c;
        }
        .delete-button:hover {
            background-color: #c0392b;
        }
        ul {
            list-style-type: none;
            padding: 0;
            border: 1px solid #eee;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            background-color: #fdfdfd;
        }
        li {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            word-break: break-word; /* 防止长文本溢出 */
        }
        li:last-child {
            border-bottom: none;
        }
        li button {
            margin-left: 10px;
            padding: 8px 12px;
            font-size: 0.9em;
        }
        pre {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
        }
        .section-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .section-box {
            background-color: #fdfdfd;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>管理面板</h1>

        <div id="status-message" class=""></div>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('chat-room-management')">聊天室管理</button>
            <button class="tab-button" onclick="switchTab('user-management')">用户管理</button>
            <button class="tab-button" onclick="switchTab('toutiao-content-management')">头条内容管理</button>
        </div>

        <!-- 聊天室管理 Tab 内容 -->
        <div id="chat-room-management" class="tab-content active">
            <h2>聊天室列表</h2>
            <button onclick="fetchRoomList()">刷新房间列表</button>
            <ul id="room-list">
                <li>加载中...</li>
            </ul>

            <h2>创建新房间</h2>
            <div class="form-group">
                <label for="new-room-name">房间名称:</label>
                <input type="text" id="new-room-name" placeholder="输入新房间名称">
            </div>
            <button onclick="createRoom()">创建房间</button>
        </div>

        <!-- 用户管理 Tab 内容 -->
        <div id="user-management" class="tab-content">
            <h2>用户列表</h2>
            <button onclick="fetchUserList()">刷新用户列表</button>
            <ul id="user-list">
                <li>加载中...</li>
            </ul>

            <h2>封禁/解封用户</h2>
            <div class="form-group">
                <label for="ban-username">用户名:</label>
                <input type="text" id="ban-username" placeholder="输入要封禁/解封的用户名">
            </div>
            <button onclick="banUser()">封禁用户</button>
            <button onclick="unbanUser()">解封用户</button>
        </div>

        <!-- 头条内容管理 Tab 内容 -->
        <div id="toutiao-content-management" class="tab-content">
            <div class="section-container">
                <div class="section-box">
                    <h2>任务队列</h2>
                    <p>当前队列长度: <span id="toutiao-queue-length">0</span></p>
                    <button onclick="fetchToutiaoQueueStatus()">刷新队列</button>
                    <button onclick="clearToutiaoQueue()" class="delete-button">清空队列</button>
                    <button onclick="processToutiaoQueue()">处理队列</button>
                    <h3>待处理任务</h3>
                    <ul id="toutiao-pending-tasks-list">
                        <li>队列为空</li>
                    </ul>
                </div>

                <div class="section-box">
                    <h2>提交新任务</h2>
                    <div class="form-group">
                        <label for="toutiao-submit-text">文章主题/内容:</label>
                        <textarea id="toutiao-submit-text" placeholder="输入文章主题或详细内容"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="toutiao-submit-username">提交者用户名:</label>
                        <input type="text" id="toutiao-submit-username" value="admin">
                    </div>
                    <button onclick="submitToutiaoTask()">提交任务</button>
                </div>

                <div class="section-box">
                    <h2>任务状态查询</h2>
                    <div class="form-group">
                        <label for="toutiao-check-task-id">任务ID:</label>
                        <input type="text" id="toutiao-check-task-id" placeholder="输入任务ID">
                    </div>
                    <button onclick="checkToutiaoTaskStatus()">查询状态</button>
                    <h3>任务详情:</h3>
                    <pre id="toutiao-task-status-display">无任务信息</pre>
                </div>

                <div class="section-box">
                    <h2>服务统计</h2>
                    <button onclick="fetchToutiaoStats()">刷新统计</button>
                    <pre id="toutiao-stats-display">加载中...</pre>
                </div>

                <div class="section-box">
                    <h2>历史发布结果</h2>
                    <button onclick="fetchToutiaoResults()">刷新结果</button>
                    <ul id="toutiao-results-list">
                        <li>加载中...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        //--CONFIG-PLACEHOLDER--//
        // 这里的 window.ENV_CONFIG 将由 Cloudflare Worker 注入
        // 例如：window.ENV_CONFIG = {"apiDomain":"your-worker-domain.com","flaskApiUrl":"https://your-flask-proxy.example.com","MANAGEMENT_ROOMS_LIST":["general","test","admin"]};

        let apiDomain = '';
        let adminSecret = '';
        let flaskApiUrl = '';
        let MANAGEMENT_ROOMS_LIST = [];

        const statusMessageDiv = document.getElementById('status-message');

        // 辅助函数：显示状态消息
        function showStatus(message, type) {
            statusMessageDiv.textContent = message;
            statusMessageDiv.className = `show ${type}`;
            setTimeout(() => {
                statusMessageDiv.className = ''; // 隐藏消息
            }, 5000);
        }

        // 辅助函数：切换 Tab
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[onclick="switchTab('${tabId}')"]`).classList.add('active');

            // 根据切换的 Tab 刷新数据
            if (tabId === 'chat-room-management') {
                fetchRoomList();
            } else if (tabId === 'user-management') {
                fetchUserList();
            } else if (tabId === 'toutiao-content-management') {
                fetchToutiaoQueueStatus();
                fetchToutiaoStats();
                fetchToutiaoResults();
            }
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 从 URL 获取 secret
            const urlParams = new URLSearchParams(window.location.search);
            adminSecret = urlParams.get('secret');

            if (!adminSecret) {
                showStatus('错误：URL 中缺少 secret 参数。请在 URL 后添加 ?secret=您的密钥', 'error');
                document.getElementById('app').innerHTML = '<h1>未授权访问</h1><p>请在URL中提供正确的管理密钥。</p>';
                return;
            }

            // 注入的配置
            if (window.ENV_CONFIG) {
                apiDomain = window.ENV_CONFIG.apiDomain || window.location.hostname;
                flaskApiUrl = window.ENV_CONFIG.flaskApiUrl;
                MANAGEMENT_ROOMS_LIST = window.ENV_CONFIG.MANAGEMENT_ROOMS_LIST || [];
            } else {
                // 如果没有注入配置，尝试从当前域名获取
                apiDomain = window.location.hostname;
                showStatus('警告：未检测到 Worker 注入的 ENV_CONFIG。部分功能可能无法正常工作。', 'info');
            }

            // 默认显示头条内容管理 Tab
            switchTab('toutiao-content-management');
        });

        // --- 聊天室管理功能 ---
        async function fetchRoomList() {
            showStatus('正在加载房间列表...', 'info');
            try {
                const domain = `https://${apiDomain}`;
                const res = await fetch(`${domain}/api/room/list?secret=${adminSecret}`);
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                const roomListUl = document.getElementById('room-list');
                roomListUl.innerHTML = '';
                if (data.rooms && data.rooms.length > 0) {
                    data.rooms.forEach(room => {
                        const li = document.createElement('li');
                        li.textContent = room;
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = '删除';
                        deleteButton.className = 'delete-button';
                        deleteButton.onclick = () => deleteRoom(room);
                        li.appendChild(deleteButton);
                        roomListUl.appendChild(li);
                    });
                } else {
                    roomListUl.innerHTML = '<li>没有房间</li>';
                }
                showStatus('房间列表加载成功。', 'success');
            } catch (e) {
                showStatus(`加载房间列表失败: ${e.message}`, 'error');
            }
        }

        async function createRoom() {
            const roomName = document.getElementById('new-room-name').value.trim();
            if (!roomName) {
                showStatus('请输入房间名称。', 'error');
                return;
            }
            showStatus(`正在创建房间: ${roomName}...`, 'info');
            try {
                const domain = `https://${apiDomain}`;
                const res = await fetch(`${domain}/api/room/create?secret=${adminSecret}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomName })
                });
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                showStatus(`房间创建成功: ${data.message}`, 'success');
                document.getElementById('new-room-name').value = '';
                fetchRoomList();
            } catch (e) {
                showStatus(`创建房间失败: ${e.message}`, 'error');
            }
        }

        async function deleteRoom(roomName) {
            if (!confirm(`确定要删除房间 "${roomName}" 吗？这将删除所有消息和用户。`)) {
                return;
            }
            showStatus(`正在删除房间: ${roomName}...`, 'info');
            try {
                const domain = `https://${apiDomain}`;
                const res = await fetch(`${domain}/api/room/delete?secret=${adminSecret}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomName })
                });
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                showStatus(`房间删除成功: ${data.message}`, 'success');
                fetchRoomList();
            } catch (e) {
                showStatus(`删除房间失败: ${e.message}`, 'error');
            }
        }

        // --- 用户管理功能 ---
        async function fetchUserList() {
            showStatus('正在加载用户列表...', 'info');
            try {
                const domain = `https://${apiDomain}`;
                const res = await fetch(`${domain}/api/users?secret=${adminSecret}`);
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                const userListUl = document.getElementById('user-list');
                userListUl.innerHTML = '';
                if (data.users && data.users.length > 0) {
                    data.users.forEach(user => {
                        const li = document.createElement('li');
                        li.textContent = `${user.username} (ID: ${user.id}) - 状态: ${user.isBanned ? '已封禁' : '正常'}`;
                        userListUl.appendChild(li);
                    });
                } else {
                    userListUl.innerHTML = '<li>没有用户</li>';
                }
                showStatus('用户列表加载成功。', 'success');
            } catch (e) {
                showStatus(`加载用户列表失败: ${e.message}`, 'error');
            }
        }

        async function banUser() {
            const username = document.getElementById('ban-username').value.trim();
            if (!username) {
                showStatus('请输入要封禁的用户名。', 'error');
                return;
            }
            showStatus(`正在封禁用户: ${username}...`, 'info');
            try {
                const domain = `https://${apiDomain}`;
                const res = await fetch(`${domain}/api/users/ban?secret=${adminSecret}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                showStatus(`用户封禁成功: ${data.message}`, 'success');
                document.getElementById('ban-username').value = '';
                fetchUserList();
            } catch (e) {
                showStatus(`封禁用户失败: ${e.message}`, 'error');
            }
        }

        async function unbanUser() {
            const username = document.getElementById('ban-username').value.trim();
            if (!username) {
                showStatus('请输入要解封的用户名。', 'error');
                return;
            }
            showStatus(`正在解封用户: ${username}...`, 'info');
            try {
                const domain = `https://${apiDomain}`;
                const res = await fetch(`${domain}/api/users/unban?secret=${adminSecret}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                showStatus(`用户解封成功: ${data.message}`, 'success');
                document.getElementById('ban-username').value = '';
                fetchUserList();
            } catch (e) {
                showStatus(`解封用户失败: ${e.message}`, 'error');
            }
        }

        // --- 头条内容管理功能 ---

        // 获取任务队列状态
        async function fetchToutiaoQueueStatus() {
            showStatus('正在加载头条任务队列...', 'info');
            try {
                const domain = `https://${apiDomain}`;
                const res = await fetch(`${domain}/api/toutiao/queue?secret=${adminSecret}`);
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();

                const queueLength = document.getElementById('toutiao-queue-length');
                const pendingTasksList = document.getElementById('toutiao-pending-tasks-list');

                queueLength.textContent = data.length || 0;
                pendingTasksList.innerHTML = '';
                if (data.tasks && data.tasks.length > 0) {
                    data.tasks.forEach(task => {
                        const li = document.createElement('li');
                        // 健壮性检查：防止 task.text 为 undefined
                        const taskText = task.text ? task.text.substring(0, Math.min(task.text.length, 50)) + (task.text.length > 50 ? '...' : '') : '无内容';
                        const taskIdShort = task.id ? task.id.substring(0, Math.min(task.id.length, 8)) + (task.id.length > 8 ? '...' : '') : 'N/A';

                        li.textContent = `ID: ${taskIdShort} | 用户: ${task.username || '未知'} | 内容: ${taskText} | 状态: ${task.status || 'pending'} | 创建时间: ${new Date(task.createdAt).toLocaleString()}`;
                        pendingTasksList.appendChild(li);
                    });
                } else {
                    pendingTasksList.innerHTML = '<li>队列为空</li>';
                }
                showStatus('头条任务队列加载成功。', 'success');
            } catch (e) {
                showStatus(`加载队列失败: ${e.message}`, 'error');
            }
        }

        // 清空任务队列
        async function clearToutiaoQueue() {
            if (!confirm('确定要清空所有待处理的头条任务队列吗？此操作不可逆！')) {
                return;
            }
            showStatus('正在清空头条任务队列...', 'info');
            try {
                const domain = `https://${apiDomain}`;
                const res = await fetch(`${domain}/api/toutiao/clearQueue?secret=${adminSecret}`, {
                    method: 'POST'
                });
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                showStatus(`队列清空成功: ${data.message}`, 'success');
                fetchToutiaoQueueStatus(); // 刷新队列显示
            } catch (e) {
                showStatus(`清空队列失败: ${e.message}`, 'error');
            }
        }

        // 处理队列中的所有任务
        async function processToutiaoQueue() {
            if (!confirm('确定要立即处理队列中的所有头条任务吗？这可能需要一些时间。')) {
                return;
            }
            showStatus('正在处理头条任务队列...', 'info');
            try {
                const domain = `https://${apiDomain}`;
                const res = await fetch(`${domain}/api/toutiao/queue?secret=${adminSecret}`, {
                    method: 'DELETE' // 使用 DELETE 方法触发处理
                });
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                showStatus(`队列处理完成。处理结果: ${JSON.stringify(data.results)}`, 'success');
                fetchToutiaoQueueStatus(); // 刷新队列显示
                fetchToutiaoStats(); // 刷新统计
                fetchToutiaoResults(); // 刷新结果
            } catch (e) {
                showStatus(`处理队列失败: ${e.message}`, 'error');
            }
        }

        // 提交新任务
        async function submitToutiaoTask() {
            const text = document.getElementById('toutiao-submit-text').value.trim();
            const username = document.getElementById('toutiao-submit-username').value.trim();

            if (!text) {
                showStatus('请输入文章主题或内容。', 'error');
                return;
            }
            if (!username) {
                showStatus('请输入提交者用户名。', 'error');
                return;
            }

            showStatus('正在提交头条任务...', 'info');
            try {
                const domain = `https://${apiDomain}`;
                const res = await fetch(`${domain}/api/toutiao/direct?secret=${adminSecret}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, username, roomName: 'management_panel' }) // 标记来源
                });
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                showStatus(`任务提交成功！任务ID: ${data.taskId}`, 'success');
                document.getElementById('toutiao-submit-text').value = '';
                fetchToutiaoQueueStatus(); // 刷新队列显示
            } catch (e) {
                showStatus(`提交任务失败: ${e.message}`, 'error');
            }
        }

        // 查询任务状态
        async function checkToutiaoTaskStatus() {
            const taskId = document.getElementById('toutiao-check-task-id').value.trim();
            if (!taskId) {
                showStatus('请输入要查询的任务ID。', 'error');
                return;
            }
            showStatus(`正在查询任务 ${taskId} 的状态...`, 'info');
            try {
                const domain = `https://${apiDomain}`;
                const res = await fetch(`${domain}/api/toutiao/status/${taskId}?secret=${adminSecret}`);
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                document.getElementById('toutiao-task-status-display').textContent = JSON.stringify(data, null, 2);
                showStatus('任务状态查询成功。', 'success');
            } catch (e) {
                document.getElementById('toutiao-task-status-display').textContent = `查询失败: ${e.message}`;
                showStatus(`查询任务状态失败: ${e.message}`, 'error');
            }
        }

        // 获取服务统计
        async function fetchToutiaoStats() {
            showStatus('正在加载头条服务统计...', 'info');
            try {
                const domain = `https://${apiDomain}`;
                const res = await fetch(`${domain}/api/toutiao/stats?secret=${adminSecret}`);
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                document.getElementById('toutiao-stats-display').textContent = JSON.stringify(data, null, 2);
                showStatus('服务统计加载成功。', 'success');
            } catch (e) {
                document.getElementById('toutiao-stats-display').textContent = `加载失败: ${e.message}`;
                showStatus(`加载服务统计失败: ${e.message}`, 'error');
            }
        }

        // 获取历史发布结果
        async function fetchToutiaoResults() {
            showStatus('正在加载历史发布结果...', 'info');
            try {
                const domain = `https://${apiDomain}`;
                const res = await fetch(`${domain}/api/toutiao/results?secret=${adminSecret}`);
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                const resultsList = document.getElementById('toutiao-results-list');
                resultsList.innerHTML = '';
                if (data && data.length > 0) {
                    data.forEach(result => {
                        const li = document.createElement('li');
                        const title = result.title || '无标题';
                        const status = result.success ? '成功' : '失败';
                        const completedAt = result.completedAt ? new Date(result.completedAt).toLocaleString() : 'N/A';
                        const errorMsg = result.publishResult && result.publishResult.error ? ` (错误: ${result.publishResult.error})` : '';
                        const url = result.publishResult && result.publishResult.url ? `<a href="${result.publishResult.url}" target="_blank">查看文章</a>` : '';

                        li.innerHTML = `<strong>${title}</strong><br>
                                        ID: ${result.id.substring(0, 8)}... | 状态: ${status}${errorMsg} | 完成时间: ${completedAt} ${url}`;
                        resultsList.appendChild(li);
                    });
                } else {
                    resultsList.innerHTML = '<li>没有历史发布结果</li>';
                }
                showStatus('历史发布结果加载成功。', 'success');
            } catch (e) {
                showStatus(`加载历史发布结果失败: ${e.message}`, 'error');
            }
        }

    </script>
</body>
</html>