<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>智能管理面板</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      type="image/svg+xml"
      href="https://pic.want.biz/favicon.svg"
    />
    <link rel="alternate icon" href="https://pic.want.biz/favicon.svg" />
    <script>
      //--CONFIG-PLACEHOLDER--//
    </script>
    <style>
      /* ====== THEME VARIABLES ====== */
      :root {
        /* 浅色默认值 */
        --bg: #f8f9fa;
        --bg-panel: #ffffff;
        --text: #2c3e50;
        --text-sub: #6c757d;
        --border: #e9ecef;
        --accent: #667eea;
        --accent2: #764ba2;
        --shadow: rgba(0, 0, 0, 0.08);
        --success: #2ecc71;
        --warning: #f39c12;
        --error: #e74c3c;
        --info: #3498db;
        transition:
          background-color 0.3s,
          color 0.3s;
      }
      [data-theme='dark'] {
        --bg: #111827;
        --bg-panel: #1f2937;
        --text: #f9fafb;
        --text-sub: #9ca3af;
        --border: #374151;
        --accent: #818cf8;
        --accent2: #a78bfa;
        --shadow: rgba(0, 0, 0, 0.4);
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --info: #3b82f6;
      }

      /* ====== Base Styles ====== */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(
          135deg,
          var(--accent) 0%,
          var(--accent2) 100%
        );
        padding: 20px;
        min-height: 100vh;
        overflow-y: auto;
      }
      .container {
        width: 100%;
        max-width: 1200px;
        margin: 20px auto;
        background: color-mix(in srgb, var(--bg-panel) 95%, transparent);
        backdrop-filter: blur(10px);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 20px 40px var(--shadow);
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      h1 {
        text-align: center;
        color: var(--text);
        margin: 0 0 8px;
        font-size: 2.2em;
        font-weight: 700;
        background: linear-gradient(45deg, var(--accent), var(--accent2));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      /* ====== Tabs Styles ====== */
      .tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 8px;
        border-bottom: 2px solid var(--border);
        padding-bottom: 5px;
        gap: 10px;
      }
      .tab-button {
        background: var(--bg);
        border: 1px solid var(--border);
        padding: 10px 15px;
        cursor: pointer;
        font-size: 0.95em;
        font-weight: 600;
        color: var(--text-sub);
        transition: all 0.3s ease;
        border-radius: 10px 10px 0 0;
        box-shadow: 0 2px 8px var(--shadow);
        position: relative;
        overflow: hidden;
      }
      .tab-button:hover {
        background: var(--bg-panel);
        color: var(--accent);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px var(--shadow);
      }
      .tab-button.active {
        background: linear-gradient(
          135deg,
          var(--accent) 0%,
          var(--accent2) 100%
        );
        color: white;
        border-color: var(--accent);
        border-bottom: 2px solid var(--accent);
        box-shadow: 0 4px 15px
          color-mix(in srgb, var(--accent) 30%, transparent);
        transform: translateY(0);
      }
      .tab-button.active:hover {
        transform: translateY(0);
      }
      .tab-content {
        display: none;
        padding-top: 8px;
      }
      .tab-content.active {
        display: block;
      }

      /* ====== General Section Styles ====== */
      .section-box {
        background: var(--bg-panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 4px 20px var(--shadow);
        display: flex;
        flex-direction: column;
        gap: 12px;
        transition: all 0.3s ease;
        margin-bottom: 16px;
      }
      .section-box h2,
      .section-box h3 {
        margin: 0;
        font-size: 1.2em;
        color: var(--text);
        font-weight: 600;
        border-bottom: 1px solid var(--border);
        padding-bottom: 8px;
        margin-bottom: 12px;
        /* 确保标题在小屏幕上换行 */
        word-break: break-word;
        overflow-wrap: break-word;
      }
      .section-box h3 {
        font-size: 1em;
        font-weight: 500;
        border-bottom: none;
        padding-bottom: 0;
        margin-bottom: 8px;
      }
      .section-box p {
        color: var(--text-sub);
        margin-bottom: 8px;
        font-size: 0.9em;
        word-break: break-word; /* 确保段落文本换行 */
        overflow-wrap: break-word;
      }
      .section-box ul {
        list-style: none;
        padding: 0;
        margin: 0;
        border: 1px solid var(--border);
        border-radius: 8px;
        max-height: 200px;
        overflow-y: auto;
        background: var(--bg);
      }
      .section-box li {
        padding: 8px 12px;
        border-bottom: 1px solid var(--border);
        color: var(--text);
        font-size: 0.9em;
        word-break: break-word; /* 确保列表项文本换行 */
        overflow-wrap: break-word;
      }
      .section-box li:last-child {
        border-bottom: none;
      }
      .section-box pre {
        background: var(--bg);
        padding: 12px;
        border-radius: 8px;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: 'Courier New', Courier, monospace;
        font-size: 0.85em;
        max-height: 150px;
        overflow-y: auto;
        color: var(--text-sub);
        border: 1px solid var(--border);
        word-break: break-word; /* 确保预格式文本换行 */
        overflow-wrap: break-word;
      }
      .section-box textarea {
        min-height: 80px;
        resize: vertical;
        width: 100%;
        padding: 10px;
        border: 2px solid var(--border);
        border-radius: 12px;
        font-size: 0.95em;
        background: linear-gradient(135deg, var(--bg) 0%, var(--bg-panel) 100%);
        color: var(--text);
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px var(--shadow);
      }
      .section-box textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow:
          0 0 0 4px color-mix(in srgb, var(--accent) 10%, transparent),
          0 4px 20px var(--shadow);
        background: var(--bg-panel);
        transform: translateY(-2px);
      }
      .input-with-clear {
        position: relative;
        display: block; /* Ensures it takes full width when inside a flex column */
        width: 100%; /* Explicitly set width for robustness */
      }
      .input-with-clear textarea {
        padding-right: 35px;
      }
      .input-clear-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 20px;
        height: 20px;
        border: none;
        background: var(--text-sub);
        color: var(--bg);
        border-radius: 50%;
        font-size: 14px;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0.7;
        transition: all 0.2s ease;
        z-index: 10;
      }
      .input-clear-btn:hover {
        opacity: 1;
        background: var(--error);
        transform: scale(1.1);
      }
      .input-clear-btn:active {
        transform: scale(0.9);
      }
      .section-box .form-group {
        margin-bottom: 0;
        gap: 8px;
      }
      .section-box button {
        padding: 8px 12px;
        font-size: 0.85em;
        border-radius: 8px;
      }
      .section-box .delete-button {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      }
      .section-box .delete-button:hover {
        background: linear-gradient(135deg, #c0392b 0%, #a03020 100%);
      }
      .section-box.highlighted {
        background: linear-gradient(
          to bottom right,
          color-mix(in srgb, var(--accent) 5%, var(--bg-panel)),
          color-mix(in srgb, var(--accent2) 5%, var(--bg-panel))
        );
        border: 2px solid var(--accent);
        box-shadow: 0 8px 30px
          color-mix(in srgb, var(--accent) 25%, var(--shadow));
        transform: translateY(-2px);
      }

      /* ====== Form & Button Styles ====== */
      .controls,
      .form-group {
        display: flex;
        gap: 12px;
        align-items: stretch;
        width: 100%;
        margin-bottom: 12px;
      }
      input[type='text'],
      select {
        flex-grow: 1;
        padding: 12px 16px;
        border: 2px solid var(--border);
        border-radius: 12px;
        font-size: 0.95em;
        background: linear-gradient(135deg, var(--bg) 0%, var(--bg-panel) 100%);
        color: var(--text);
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px var(--shadow);
        height: 44px;
        box-sizing: border-box;
      }
      input[type='text']::placeholder {
        color: var(--text-sub);
      }
      input[type='text']:focus,
      select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow:
          0 0 0 4px color-mix(in srgb, var(--accent) 10%, transparent),
          0 4px 20px var(--shadow);
        background: var(--bg-panel);
        transform: translateY(-2px);
      }
      button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 18px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 0.95em;
        font-weight: 600;
        transition: all 0.3s ease;
        flex-shrink: 0;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        position: relative;
        overflow: hidden;
      }
      button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }
      button:hover::before {
        left: 100%;
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px
          color-mix(in srgb, var(--accent) 40%, transparent);
      }
      button:active {
        transform: translateY(0);
        box-shadow: 0 4px 15px
          color-mix(in srgb, var(--accent) 30%, transparent);
      }
      button:disabled {
        background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .clear-button {
        background: linear-gradient(135deg, #ff6b6b 0%, #ff5252 100%);
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
      }
      .clear-button:hover {
        background: linear-gradient(135deg, #ff5252 0%, #ff3d3d 100%);
        box-shadow: 0 8px 25px rgba(255, 82, 82, 0.4);
      }
      .submit-button {
        background: linear-gradient(
          135deg,
          var(--success) 0%,
          var(--accent) 100%
        );
        font-size: 1em !important;
        padding: 12px 20px !important;
        border-radius: 12px !important;
        font-weight: 600;
        letter-spacing: 0.5px;
        box-shadow: 0 8px 25px
          color-mix(in srgb, var(--success) 30%, var(--shadow));
      }
      .submit-button:hover {
        transform: translateY(-3px) !important;
        box-shadow: 0 12px 30px
          color-mix(in srgb, var(--success) 50%, var(--shadow)) !important;
      }
      .refresh-button {
        background: linear-gradient(135deg, var(--info) 0%, var(--accent2) 70%);
      }

      /* ====== Status & Tags ====== */
      #status-message,
      .status-display {
        text-align: center;
        min-height: 24px;
        padding: 10px 14px;
        font-size: 0.9em;
        transition: all 0.3s ease;
        border-radius: 8px;
        font-weight: 500;
        margin-bottom: 12px;
      }
      .status-success {
        color: var(--success);
        background: color-mix(in srgb, var(--success) 10%, transparent);
        border: 1px solid color-mix(in srgb, var(--success) 20%, transparent);
      }
      .status-error {
        color: var(--error);
        background: color-mix(in srgb, var(--error) 10%, transparent);
        border: 1px solid color-mix(in srgb, var(--error) 20%, transparent);
      }
      .status-info {
        color: var(--info);
        background: color-mix(in srgb, var(--info) 10%, transparent);
        border: 1px solid color-mix(in srgb, var(--info) 20%, transparent);
      }
      .status-tag {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.8em;
        font-weight: 600;
        margin-right: 6px;
      }
      .status-tag.success {
        background-color: color-mix(in srgb, var(--success) 20%, transparent);
        color: var(--success);
        border: 1px solid var(--success);
      }
      .status-tag.error {
        background-color: color-mix(in srgb, var(--error) 20%, transparent);
        color: var(--error);
        border: 1px solid var(--error);
      }
      .status-tag.pending {
        background-color: color-mix(in srgb, var(--warning) 20%, transparent);
        color: var(--warning);
        border: 1px solid var(--warning);
      }
      .status-tag.processing {
        background-color: color-mix(in srgb, var(--accent) 20%, transparent);
        color: var(--accent);
        border: 1px solid var(--accent);
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      /* ====== Inspiration/News Card Styles ====== */
      .inspiration-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
        margin-top: 8px;
      }
      .inspiration-card {
        background: var(--bg-panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        transition: all 0.3s ease;
        position: relative;
        box-shadow: 0 4px 12px var(--shadow);
        font-size: 0.9em;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .inspiration-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px var(--shadow);
        border-color: var(--accent);
      }
      .inspiration-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 8px;
      }
      .inspiration-card-title {
        color: var(--text);
        font-size: 1em;
        font-weight: 600;
        line-height: 1.4;
        margin: 0;
        flex: 1;
        word-break: break-word;
        overflow-wrap: break-word;
      }
      .inspiration-card-source {
        font-size: 0.75em;
        color: var(--text-sub);
        background: var(--bg);
        padding: 3px 8px;
        border-radius: 20px;
        white-space: nowrap;
      }
      .inspiration-card-description {
        font-size: 0.85em;
        color: var(--text-sub);
        margin: 0;
        line-height: 1.5;
        flex-grow: 1;
        word-break: break-word;
        overflow-wrap: break-word;
      }
      .inspiration-card-actions {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        padding-top: 8px;
        border-top: 1px solid var(--border);
      }
      .inspiration-card-actions button {
        padding: 6px 12px;
        font-size: 0.8em;
        border-radius: 8px;
        flex: 1;
        min-width: 0;
      }

      /* ====== Specific Tab Content ====== */
      .section-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 16px;
        margin-top: 0;
      }
      .latest-result {
        background: linear-gradient(
          135deg,
          color-mix(in srgb, var(--success) 10%, var(--bg)),
          color-mix(in srgb, var(--accent) 5%, var(--bg))
        );
        border: 2px solid var(--success);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 6px 20px
          color-mix(in srgb, var(--success) 20%, var(--shadow));
        animation: glow 2s ease-in-out infinite alternate;
      }
      .latest-result.error {
        background: linear-gradient(
          135deg,
          color-mix(in srgb, var(--error) 10%, var(--bg)),
          color-mix(in srgb, var(--bg) 98%, var(--error))
        );
        border: 2px solid var(--error);
        box-shadow: 0 6px 20px
          color-mix(in srgb, var(--error) 20%, var(--shadow));
      }
      /* Ensure content inside latest-result-content wraps */
      #latest-result-content div {
        word-break: break-word;
        overflow-wrap: break-word;
      }

      @keyframes glow {
        from {
          box-shadow: 0 6px 20px
            color-mix(in srgb, var(--accent) 20%, var(--shadow));
        }
        to {
          box-shadow: 0 8px 25px
            color-mix(in srgb, var(--accent) 40%, var(--shadow));
        }
      }
      .theme-toggle-btn {
        position: absolute;
        top: 50%;
        right: 0;
        transform: translateY(-50%);
        background: none;
        border: 1px solid var(--border);
        color: var(--text-sub);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .theme-toggle-btn:hover {
        background-color: var(--bg);
        border-color: var(--accent);
        color: var(--accent);
      }

      /* ====== Responsive ====== */
      @media (max-width: 768px) {
        body {
          padding: 8px;
        }
        .container {
          padding: 16px;
          margin: 10px auto;
          gap: 16px;
        }
        h1 {
          font-size: 1.6em;
        }
        .section-container,
        .inspiration-grid {
          grid-template-columns: 1fr; /* Force single column layout */
        }
        .tabs {
          flex-wrap: wrap;
          justify-content: flex-start; /* Align tabs to start, allows wrapping */
        }
        .tab-button {
          flex: 1 0 auto; /* Allow buttons to grow/shrink based on content, wrap if needed */
          font-size: 0.9em;
          padding: 8px 12px;
          min-width: unset; /* Remove explicit min-width */
          max-width: 100%; /* Ensure it doesn't try to be too wide */
        }

        /* FIX FOR MOBILE OVERFLOW AND LAYOUT:
     * Force inputs, selects, and buttons to stack vertically and take full width
     * within their respective form-group/controls containers.
     */
        .controls,
        .form-group {
          flex-direction: column; /* Stack items vertically */
          gap: 8px; /* Consistent spacing between stacked items */
          align-items: stretch; /* Make children fill the width */
          margin-bottom: 12px; /* Maintain spacing with other sections */
          width: 100%; /* Ensure the flex container itself takes full width */
        }

        /* Ensure inputs and selects always take full width */
        input[type='text'],
        select {
          width: 100%; /* Explicitly set width to 100% */
          min-width: 0; /* Allow shrinking if parent has constraints */
          flex-shrink: 1; /* Allow to shrink */
          flex-grow: 1; /* Allow to grow */
          margin-bottom: 0; /* Let gap handle spacing */
        }

        /* Ensure textarea also takes full width */
        .section-box textarea {
          width: 100%;
          min-width: 0;
        }

        /* Ensure the input-with-clear wrapper takes full width */
        .input-with-clear {
          width: 100%; /* Force full width */
          flex: 1 1 auto; /* Be flexible within its parent, allows shrinking */
          min-width: 0; /* Prevent overflow */
        }

        /* Ensure buttons also take full width when stacked vertically */
        .form-group button,
        .controls button {
          width: 100%; /* Explicitly set button width to 100% */
          flex-shrink: 1; /* Allow to shrink */
          flex-grow: 1; /* Allow to grow */
          min-width: 0; /* Prevent overflow */
          padding: 12px 18px; /* Restore original padding for full-width buttons */
        }

        /* Labels should take full width and stack above their inputs */
        .form-group label {
          width: 100%; /* Make label take full width */
          margin-bottom: 4px; /* Maintain spacing below label */
          text-align: left; /* Align label text to left for readability */
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div style="position: relative; text-align: center">
        <h1>智能管理面板</h1>
        <button
          onclick="toggleTheme()"
          class="theme-toggle-btn"
          title="切换深色模式"
        >
          🌓
        </button>
      </div>

      <!-- 统计信息展示区 -->
      <div id="stats-container" class="section-box" style="display: none; padding: 10px;">
        <div style="display: flex; justify-content: center; text-align: center; gap: 30px;">
          <div>
            <div id="total-tasks-count" style="font-size: 2em; font-weight: bold; color: var(--accent);">0</div>
            <div style="font-size: 0.9em;">总任务数</div>
          </div>
          <div>
            <div id="successful-tasks-count" style="font-size: 2em; font-weight: bold; color: var(--success);">0</div>
            <div style="font-size: 0.9em;">成功任务</div>
          </div>
          <div>
            <div id="failed-tasks-count" style="font-size: 2em; font-weight: bold; color: var(--error);">0</div>
            <div style="font-size: 0.9em;">失败任务</div>
          </div>
        </div>
      </div>

      <!-- Tabs 区域 -->
      <div class="tabs">
        <button
          class="tab-button active"
          onclick="switchTab('inspiration-management')"
        >
          知乎
        </button>
        <button class="tab-button" onclick="switchTab('news-management')">
          热点
        </button>
        <button class="tab-button" onclick="switchTab('publish-management')">
          头条
        </button>
        <button class="tab-button" onclick="switchTab('user-management')">
          用户
        </button>
      </div>

      <!-- 灵感管理 Tab (知乎) -->
      <div id="inspiration-management" class="tab-content active">
        <!-- 新增：自定义发布模块 -->
        <div class="section-box highlighted">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h2 style="margin: 0; border: none; display: flex; align-items: center; gap: 8px;">
              ✨ 文思泉涌
            </h2>
          </div>
          <p style="margin-top: 0; margin-bottom: 12px;">输入任何主题、大纲或内容，AI自动写文章并头条。</p>
          <div class="input-with-clear" style="margin-bottom: 12px;">
            <textarea
              id="custom-inspiration-text"
              placeholder="例如：写一篇关于“AI在量化交易中的应用”的文章，侧重于风险控制。"
            ></textarea>
            <button
              type="button"
              class="input-clear-btn"
              onclick="clearCustomInspirationText()"
              title="清除内容"
            >
              ×
            </button>
          </div>
          <details style="margin-bottom: 12px;">
            <summary style="cursor: pointer; color: var(--text-sub); font-size: 0.9em; margin-bottom: 8px;">发布选项</summary>
            <div class="form-group" style="margin-top: 8px;">
              <label
                for="custom-inspiration-room-select"
                style="white-space: nowrap; align-self: center; font-weight: 500; min-width: 60px;"
                >发布到:</label
              >
              <select id="custom-inspiration-room-select" style="flex: 1;"></select>
            </div>
          </details>
          <div class="form-group">
            <button
              id="submit-custom-inspiration-btn"
              onclick="submitCustomInspiration()"
              class="submit-button"
              style="flex: 1;"
            >
              ✍️ 生成并发布
            </button>
          </div>
          <div
            id="custom-inspiration-status"
            class="status-display"
            style="display: none; margin-top: 10px;"
          ></div>
        </div>

        <!-- 知乎灵感模块 -->
        <div class="section-box">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h2 style="margin: 0; border: none; display: flex; align-items: center; gap: 8px;">
              💡 知乎灵感
              <span id="inspiration-count" style="font-size: 0.8em; background: var(--accent); color: white; padding: 2px 8px; border-radius: 10px;"></span>
            </h2>
            <button onclick="fetchInspirations()" class="refresh-button" style="padding: 4px 10px; font-size: 0.85em;">
              🔄
            </button>
          </div>
          <div class="form-group" style="margin-bottom: 12px;">
            <div class="input-with-clear" style="flex: 1">
              <input
                type="text"
                id="inspiration-topic-input"
                placeholder="输入关键词筛选"
              />
              <button
                type="button"
                class="input-clear-btn"
                onclick="clearInspirationInput()"
                title="清除输入"
              >
                ×
              </button>
            </div>
            <button onclick="fetchInspirations()" style="padding: 8px 12px;">
              筛选
            </button>
          </div>
          <details>
            <summary style="cursor: pointer; color: var(--text-sub); font-size: 0.9em; margin-bottom: 10px;">高级选项</summary>
            <div class="form-group" style="margin-top: 8px;">
              <label
                for="fetched-inspiration-room-select"
                style="white-space: nowrap; align-self: center; font-weight: 500; min-width: 60px;"
                >发布到:</label
              >
              <select id="fetched-inspiration-room-select" style="flex: 1;"></select>
            </div>
          </details>
          <div
            id="inspiration-status"
            class="status-display"
            style="display: none; margin-top: 10px;"
          ></div>
          <div id="inspiration-topics-container" class="inspiration-grid">
            <div
              class="inspiration-card"
              style="
                justify-content: center;
                align-items: center;
                min-height: 120px;
              "
            >
              <span style="color: var(--text-sub); font-style: italic"
                >加载中...</span
              >
            </div>
          </div>
        </div>
      </div>

      <!-- 新闻管理 Tab (热点) -->
      <div id="news-management" class="tab-content">
        <div class="section-box">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h2 style="margin: 0; border: none; display: flex; align-items: center; gap: 8px;">
              📰 全网新闻
              <span id="news-count" style="font-size: 0.8em; background: var(--accent); color: white; padding: 2px 8px; border-radius: 10px;"></span>
            </h2>
            <button onclick="fetchNews()" class="refresh-button" style="padding: 4px 10px; font-size: 0.85em;">
              🔄
            </button>
          </div>
          <div class="form-group" style="margin-bottom: 12px;">
            <div class="input-with-clear" style="flex: 1">
              <input
                type="text"
                id="news-topic-input"
                placeholder="输入关键词筛选新闻"
              />
              <button
                type="button"
                class="input-clear-btn"
                onclick="clearNewsInput()"
                title="清除输入"
                style="display: none;"
              >
                ×
              </button>
            </div>
            <button onclick="searchNewsTopics()" style="padding: 8px 12px;">
              筛选
            </button>
          </div>
          <details>
            <summary style="cursor: pointer; color: var(--text-sub); font-size: 0.9em; margin-bottom: 10px;">高级选项</summary>
            <div class="form-group" style="margin-top: 8px;">
              <label
                for="news-room-select"
                style="white-space: nowrap; align-self: center; font-weight: 500; min-width: 60px;"
                >发布到:</label
              >
              <select id="news-room-select" style="flex: 1;"></select>
            </div>
          </details>
          <div
            id="news-status"
            class="status-display"
            style="display: none; margin-top: 10px;"
          ></div>
          <div id="news-topics-container" class="inspiration-grid">
            <div
              class="inspiration-card"
              style="
                justify-content: center;
                align-items: center;
                min-height: 120px;
              "
            >
              <span style="color: var(--text-sub); font-style: italic"
                >加载中...</span
              >
            </div>
          </div>
        </div>
      </div>

      <!-- 发布管理 Tab (头条) -->
      <div id="publish-management" class="tab-content">
        <!-- 最新发布结果 -->
        <div
          id="latest-result-container"
          class="section-box latest-result"
          style="display: none"
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            "
          >
            <h2 style="margin: 0; border: none; padding: 0">最新发布结果</h2>
            <span
              id="latest-result-time"
              style="font-size: 0.85em; color: var(--text-sub)"
            ></span>
          </div>
          <div id="latest-result-content"></div>
        </div>

        <!-- 修正：将原本错误放置的 </div> 移到此处，以包含所有“发布管理”的内容 -->
        <div class="section-container">
          <!-- 历史发布结果 -->
          <div class="section-box highlighted">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 100%;
              "
            >
              <h2>📋 历史发布结果</h2>
              <button
                onclick="fetchPublishResults()"
                class="refresh-button"
                style="padding: 6px 10px; font-size: 0.8em"
              >
                🔄 刷新
              </button>
            </div>
            <ul id="publish-results-list" style="max-height: 300px">
              <li>加载中...</li>
            </ul>
          </div>
          <!-- 任务队列 -->
          <div class="section-box">
            <h2>🕒 任务队列</h2>
            <p>
              当前队列长度:
              <span
                id="publish-queue-length"
                style="font-weight: 600; color: var(--accent)"
                >0</span
              >
            </p>
            <div class="form-group" style="gap: 8px; margin-bottom: 8px">
              <button onclick="fetchPublishQueueStatus()">🔄 刷新队列</button>
              <button onclick="clearPublishQueue()" class="delete-button">
                🗑️ 清空队列
              </button>
              <button onclick="processPublishQueue()">▶️ 处理队列</button>
            </div>
            <h3>待处理任务</h3>
            <ul id="publish-pending-tasks-list">
              <li>队列为空</li>
            </ul>
          </div>
          <!-- 任务状态查询 -->
          <div class="section-box">
            <h2>🔍 任务状态查询</h2>
            <div class="form-group">
              <input
                type="text"
                id="publish-check-task-id"
                placeholder="输入任务ID"
              />
              <button onclick="checkPublishTaskStatus()">查询状态</button>
            </div>
            <h3>任务详情:</h3>
            <pre id="publish-task-status-display">无任务信息</pre>
          </div>
          <!-- 服务统计 -->
          <div class="section-box">
            <h2>📊 服务统计</h2>
            <button onclick="fetchPublishStats()">刷新统计</button>
            <pre id="publish-stats-display">加载中...</pre>
          </div>
        </div>
      </div> <!-- <--- 这是 "publish-management" 正确的结束标签位置 -->

      <!-- 用户管理 Tab -->
      <div id="user-management" class="tab-content">
        <div class="section-box">
          <h2>已激活的房间</h2>
          <ul
            id="activated-room-list"
            style="
              display: flex;
              flex-wrap: wrap;
              gap: 10px;
              padding: 0;
              border: none;
              background: none;
            "
          >
            <li
              class="no-rooms"
              style="
                background: none;
                border: 2px dashed var(--text-sub);
                color: var(--text-sub);
                cursor: default;
                font-style: italic;
              "
            >
              正在加载房间...
            </li>
          </ul>
        </div>
        <div class="section-box">
          <h2>白名单管理</h2>
          <p>
            💡 使用说明： <br />• 每个房间可以单独设置白名单 <br />•
            只有白名单中的用户才能访问房间功能 <br />•
            需要管理员密钥才能修改白名单
          </p>
          <div class="controls">
            <input
              type="text"
              id="room-name-input"
              placeholder="输入或选择房间名 (e.g., test)"
            />
            <button id="load-users-btn">加载</button>
          </div>
          <div id="status-message" class="status-display"></div>
          <ul id="user-list">
            <li style="justify-content: center; color: #7f8c8d">
              请选择或输入房间名加载白名单
            </li>
          </ul>
          <div class="form-group">
            <input
              type="text"
              id="new-user-input"
              placeholder="输入要添加的用户名"
            />
            <button id="add-user-btn">添加</button>
          </div>
        </div>
      </div>

    <script>
      // =================================================================
      //  Initialization & Config
      // =================================================================
      const potentialRoomsToCheck = window.MANAGEMENT_ROOMS_LIST || [
        'test',
        'future',
        'admin',
        'kerry',
      ]
      const envConfig = window.ENV_CONFIG || {}
      const apiDomain = window.ENV_CONFIG.apiDomain
      const urlParams = new URLSearchParams(window.location.search)
      const adminSecret = urlParams.get('secret')
      const initialRoom = urlParams.get('room')

      // Store fetched data
      let allInspirationsData = []
      let allNewsData = []

      // =================================================================
      //  DOM Element Declarations
      // =================================================================
      // User Management
      const roomNameInput = document.getElementById('room-name-input')
      const userList = document.getElementById('user-list')
      const newUserInput = document.getElementById('new-user-input')
      const addUserBtn = document.getElementById('add-user-btn')
      const loadUsersBtn = document.getElementById('load-users-btn')
      const statusMessage = document.getElementById('status-message')
      const activatedRoomList = document.getElementById('activated-room-list')

      // Inspiration Management
      const customInspirationText = document.getElementById(
        'custom-inspiration-text',
      )
      const customInspirationRoomSelect = document.getElementById(
        'custom-inspiration-room-select',
      )
      const customInspirationStatus = document.getElementById(
        'custom-inspiration-status',
      )
      const inspirationTopicInput = document.getElementById(
        'inspiration-topic-input',
      )
      const fetchedInspirationRoomSelect = document.getElementById(
        'fetched-inspiration-room-select',
      )
      const inspirationTopicsContainer = document.getElementById(
        'inspiration-topics-container',
      )
      const inspirationStatus = document.getElementById('inspiration-status')

      // News Management
      const newsTopicInput = document.getElementById('news-topic-input')
      const newsRoomSelect = document.getElementById('news-room-select')
      const newsTopicsContainer = document.getElementById(
        'news-topics-container',
      )
      const newsStatus = document.getElementById('news-status')

      // Publish Management
      const publishQueueLength = document.getElementById('publish-queue-length')
      const publishPendingTasksList = document.getElementById(
        'publish-pending-tasks-list',
      )
      const publishCheckTaskId = document.getElementById(
        'publish-check-task-id',
      )
      const publishTaskStatusDisplay = document.getElementById(
        'publish-task-status-display',
      )
      const publishStatsDisplay = document.getElementById(
        'publish-stats-display',
      )
      const publishResultsList = document.getElementById('publish-results-list')
      const latestResultContainer = document.getElementById(
        'latest-result-container',
      )
      const latestResultContent = document.getElementById(
        'latest-result-content',
      )
      const latestResultTime = document.getElementById('latest-result-time')
      // Stats Container
      const statsContainer = document.getElementById('stats-container');

      // =================================================================
      //  Core UI & Helpers
      // =================================================================
      function initTheme() {
        const saved = localStorage.getItem('theme')
        const prefersDark = window.matchMedia(
          '(prefers-color-scheme: dark)',
        ).matches
        const theme = saved ? saved : prefersDark ? 'dark' : 'light'
        document.documentElement.setAttribute('data-theme', theme)
      }

      function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme')
        const next = current === 'dark' ? 'light' : 'dark'
        document.documentElement.setAttribute('data-theme', next)
        localStorage.setItem('theme', next)
      }

      function updateStatus(element, msg, type = 'info', show = true) {
        element.textContent = msg
        element.className = `status-display status-${type}`
        element.style.display = show ? 'block' : 'none'
      }

      function populateRoomSelects() {
        const selects = [
          customInspirationRoomSelect,
          fetchedInspirationRoomSelect,
          newsRoomSelect,
        ]
        selects.forEach(select => {
          if (!select) return
          select.innerHTML = ''
          potentialRoomsToCheck.forEach(room => {
            const option = document.createElement('option')
            option.value = room
            option.textContent = room
            select.appendChild(option)
          })
        })
      }

      function switchTab(tabId) {
        document
          .querySelectorAll('.tab-content')
          .forEach(c => c.classList.remove('active'))
        document
          .querySelectorAll('.tab-button')
          .forEach(b => b.classList.remove('active'))
        document.getElementById(tabId).classList.add('active')
        document
          .querySelector(`.tab-button[onclick="switchTab('${tabId}')"]`)
          .classList.add('active')

        switch (tabId) {
          case 'inspiration-management':
            if (allInspirationsData.length === 0) fetchInspirations()
            break
          case 'news-management':
            if (allNewsData.length === 0) fetchNews()
            break
          case 'publish-management':
            fetchPublishQueueStatus()
            fetchPublishStats()
            fetchPublishResults()
            break
          case 'user-management':
            fetchActivatedRooms()
            if (initialRoom) {
              roomNameInput.value = initialRoom
              fetchUsers()
            }
            break
        }
      }

      // =================================================================
      //  Unified Article Generation & Submission
      // =================================================================
      async function generateArticleFromInspiration(
        inspirationItem,
        roomName,
        buttonElement,
        statusUpdater,
      ) {
        if (!inspirationItem || !roomName) {
          statusUpdater('未能找到话题的详细信息或目标房间', 'error', true)
          return
        }

        const originalText = buttonElement.innerHTML
        buttonElement.disabled = true
        buttonElement.innerHTML = '生成中...'
        statusUpdater(`正在为房间 [${roomName}] 提交生成任务...`, 'info', true)

        try {
          const domain = `https://${apiDomain || 'api.yuangs.cc'}`
          const res = await fetch(`${domain}/api/inspirations/generate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              inspiration: inspirationItem,
              roomName: roomName,
              secret: adminSecret,
            }),
          })

          const data = await res.json()
          if (res.ok && data.success) {
            statusUpdater(
              `✅ 任务已成功提交 (ID: ${data.taskId.substring(0, 8)}...)，请稍后在“发布管理”页查看。`,
              'success',
              true,
            )
            fetchPublishQueueStatus() // Auto-refresh queue
          } else {
            throw new Error(data.message || '未知错误')
          }
        } catch (e) {
          statusUpdater(`❌ 生成文章失败: ${e.message}`, 'error', true)
        } finally {
          buttonElement.disabled = false
          buttonElement.innerHTML = originalText
        }
      }

      function submitCustomInspiration() {
        const text = customInspirationText.value.trim()
        const room = customInspirationRoomSelect.value
        const button = document.getElementById('submit-custom-inspiration-btn')

        if (!text) {
          updateStatus(
            customInspirationStatus,
            '请输入主题或内容！',
            'error',
            true,
          )
          return
        }

        const customInspiration = {
          title: text.substring(0, 50), // Use first 50 chars as title
          contentPrompt: text, // Full text is the prompt
          type: 'custom',
        }

        generateArticleFromInspiration(
          customInspiration,
          room,
          button,
          (msg, type, show) =>
            updateStatus(customInspirationStatus, msg, type, show),
        )
      }

      function clearCustomInspirationText() {
        const textarea = document.getElementById('custom-inspiration-text')
        const clearBtn = document.querySelector('.input-clear-btn')
        if (textarea) {
          textarea.value = ''
          textarea.focus()
          if (clearBtn) clearBtn.style.display = 'none'
          updateStatus(customInspirationStatus, '内容已清除', 'success', true)
          setTimeout(() => {
            updateStatus(customInspirationStatus, '', 'success', false)
          }, 2000)
        }
      }

      // 监听输入框内容变化，控制清除按钮显示
      document.addEventListener('DOMContentLoaded', function () {
        const textarea = document.getElementById('custom-inspiration-text')
        const clearBtn = document.querySelector('.input-clear-btn')

        if (textarea && clearBtn) {
          function updateClearButtonVisibility() {
            clearBtn.style.display = textarea.value.trim() ? 'flex' : 'none'
          }

          // 初始状态检查
          updateClearButtonVisibility()

          // 监听输入事件
          textarea.addEventListener('input', updateClearButtonVisibility)

          // 监听粘贴事件
          textarea.addEventListener('paste', function () {
            setTimeout(updateClearButtonVisibility, 0)
          })
        }
      })

      // =================================================================
      //  Inspiration & News Fetching and Rendering
      // =================================================================
      async function fetchInspirations() {
        updateStatus(inspirationStatus, '正在获取知乎灵感...', 'info', true)
        inspirationTopicsContainer.innerHTML =
          '<div class="inspiration-card" style="justify-content: center; align-items: center;"><span style="color: var(--text-sub);">加载中...</span></div>'
        try {
          const domain = `https://${apiDomain || 'api.yuangs.cc'}`
          // 专门获取知乎相关的内容，避免与新闻重复
          const res = await fetch(
            `${domain}/api/inspirations?secret=${adminSecret}&source=zhihu`,
          )
          if (!res.ok) throw new Error(await res.text())
          const data = await res.json()
          // 过滤出知乎相关的灵感
          allInspirationsData =
            data.data.filter(
              item => item.source && item.source.includes('知乎'),
            ) || []

          // 更新计数显示
          const countElement = document.getElementById('inspiration-count');
          if (countElement) {
            countElement.textContent = allInspirationsData.length;
          }

          // 获取关键词并筛选
          const keyword = inspirationTopicInput.value.trim().toLowerCase()
          if (keyword) {
            const filtered = allInspirationsData.filter(t =>
              t.title.toLowerCase().includes(keyword),
            )
            renderInspirations(filtered)
            updateStatus(
              inspirationStatus,
              `成功获取 ${allInspirationsData.length} 个知乎灵感，筛选出 ${filtered.length} 个`,
              'success',
              false,
            )
          } else {
            renderInspirations(allInspirationsData)
            updateStatus(
              inspirationStatus,
              `成功获取 ${allInspirationsData.length} 个知乎灵感`,
              'success',
              false,
            )
          }
        } catch (e) {
          updateStatus(
            inspirationStatus,
            `获取知乎灵感失败: ${e.message}`,
            'error',
            true,
          )
        }
      }

      async function fetchNews() {
        updateStatus(newsStatus, '正在获取全网新闻...', 'info', true)
        newsTopicsContainer.innerHTML =
          '<div class="inspiration-card" style="justify-content: center; align-items: center;"><span style="color: var(--text-sub);">加载中...</span></div>'
        try {
          const domain = `https://${apiDomain || 'api.yuangs.cc'}`
          // 专门获取新闻内容（抖音、微博、虎扑等），排除知乎内容
          const res = await fetch(
            `${domain}/api/inspirations?secret=${adminSecret}&type=news`,
          )
          if (!res.ok) throw new Error(await res.text())
          const data = await res.json()
          allNewsData =
            data.data.filter(
              item => item.source && !item.source.includes('知乎'),
            ) || []
          
          // 更新计数显示
          const countElement = document.getElementById('news-count');
          if (countElement) {
            countElement.textContent = allNewsData.length;
          }
          
          renderNews(allNewsData)
          updateStatus(
            newsStatus,
            `成功获取 ${allNewsData.length} 个全网新闻`,
            'success',
            false,
          )
        } catch (e) {
          updateStatus(
            newsStatus,
            `获取全网新闻失败: ${e.message}`,
            'error',
            true,
          )
        }
      }

      function clearInspirationInput() {
        inspirationTopicInput.value = ''
        renderInspirations(allInspirationsData)
        updateStatus(inspirationStatus, '已清除筛选条件', 'success', true)
        inspirationTopicInput.focus()

        // 隐藏清除按钮
        const clearBtn =
          inspirationTopicInput.parentElement.querySelector('.input-clear-btn')
        if (clearBtn) {
          clearBtn.style.display = 'none'
        }
      }

      function clearNewsInput() {
        newsTopicInput.value = ''
        renderNews(allNewsData)
        updateStatus(newsStatus, '已清除筛选条件', 'success', true)
        newsTopicInput.focus()

        // 隐藏清除按钮
        const clearBtn =
          newsTopicInput.parentElement.querySelector('.input-clear-btn')
        if (clearBtn) {
          clearBtn.style.display = 'none'
        }
      }

      function searchNewsTopics() {
        const keyword = newsTopicInput.value.trim().toLowerCase()
        const filtered = allNewsData.filter(t =>
          t.title.toLowerCase().includes(keyword),
        )
        renderNews(filtered)
        updateStatus(
          newsStatus,
          `筛选出 ${filtered.length} 个新闻`,
          'info',
          true,
        )
      }

      function renderInspirations(topics) {
        renderCards(
          topics,
          inspirationTopicsContainer,
          fetchedInspirationRoomSelect,
          updateInspirationStatus,
        )
      }

      function renderNews(topics) {
        renderCards(
          topics,
          newsTopicsContainer,
          newsRoomSelect,
          updateNewsStatus,
        )
      }

      function updateInspirationStatus(msg, type, show) {
        updateStatus(inspirationStatus, msg, type, show)
      }
      function updateNewsStatus(msg, type, show) {
        updateStatus(newsStatus, msg, type, show)
      }

      function renderCards(items, container, roomSelectElement, statusUpdater) {
        container.innerHTML = ''
        if (!items || items.length === 0) {
          container.innerHTML =
            '<div class="inspiration-card" style="text-align: center; padding: 30px;"><p>暂无数据</p></div>'
          return
        }
        items.forEach((item, index) => {
          const card = document.createElement('div')
          card.className = 'inspiration-card'

          // 创建卡片头部（标题和来源）
          const header = document.createElement('div')
          header.className = 'inspiration-card-header'
          
          const title = document.createElement('h3')
          title.className = 'inspiration-card-title'
          title.textContent = item.title

          const source = document.createElement('div')
          source.className = 'inspiration-card-source'
          source.textContent = item.source || '未知来源'

          header.appendChild(title)
          header.appendChild(source)

          // 创建描述部分
          const description = document.createElement('div')
          description.className = 'inspiration-card-description'
          const descriptionContent = item.excerpt || item.description || ''
          description.textContent = descriptionContent

          // 创建操作按钮区域
          const actions = document.createElement('div')
          actions.className = 'inspiration-card-actions'

          const generateBtn = document.createElement('button')
          generateBtn.innerHTML = '✍️ 一键成文'
          generateBtn.className = 'submit-button'
          generateBtn.onclick = e => {
            e.stopPropagation()
            const selectedRoom = roomSelectElement.value
            generateArticleFromInspiration(
              item,
              selectedRoom,
              generateBtn,
              statusUpdater,
            )
          }

          const viewBtn = document.createElement('button')
          viewBtn.textContent = '原文'
          viewBtn.style.background = 'var(--bg)'
          viewBtn.style.color = 'var(--text)'
          viewBtn.style.border = '1px solid var(--border)'
          viewBtn.onclick = e => {
            e.stopPropagation()
            if (item.url) {
              // 尝试使用应用协议打开，如果失败则在新标签页打开
              const link = document.createElement('a');
              link.href = item.url;
              link.target = '_blank';
              link.rel = 'noopener noreferrer';
              link.click();
            }
          }

          actions.appendChild(generateBtn)
          if (item.url) actions.appendChild(viewBtn)

          // 组装卡片
          card.appendChild(header)
          if (descriptionContent) card.appendChild(description)
          card.appendChild(actions)
          container.appendChild(card)
        })
      }

      // =================================================================
      //  Publish Management Functions
      // =================================================================
      async function fetchPublishQueueStatus() {
        try {
          const domain = `https://${apiDomain || 'api.yuangs.cc'}`
          console.log(
            'Fetching queue status from:',
            `${domain}/api/toutiao/queue?secret=${adminSecret}`,
          )
          const res = await fetch(
            `${domain}/api/toutiao/queue?secret=${adminSecret}`,
          )
          if (!res.ok) {
            const errorText = await res.text()
            console.error('Failed to fetch queue status:', errorText)
            throw new Error(errorText)
          }
          const data = await res.json()
          console.log('Queue status data:', data)
          publishQueueLength.textContent = data.length || 0
          publishPendingTasksList.innerHTML = ''
          if (data.tasks && data.tasks.length > 0) {
            data.tasks.forEach(task => {
              const li = document.createElement('li')
              const taskText =
                (
                  task.text ||
                  task.data?.text ||
                  task.content ||
                  '无内容'
                ).substring(0, 50) + '...'
              const status = task.status || 'pending'
              const statusClass =
                status === 'pending'
                  ? 'status-tag pending'
                  : status === 'processing'
                    ? 'status-tag processing'
                    : status === 'completed'
                      ? 'status-tag success'
                      : status === 'failed'
                        ? 'status-tag error'
                        : 'status-tag'

              li.innerHTML = `<strong>ID:</strong> ${task.id.substring(0, 8)}... <strong>内容:</strong> ${taskText} <span class="${statusClass}">${status}</span>`
              publishPendingTasksList.appendChild(li)
            })
          } else {
            publishPendingTasksList.innerHTML = '<li>队列为空</li>'
          }
        } catch (e) {
          console.error('Error fetching queue status:', e)
          publishPendingTasksList.innerHTML = `<li style="color: var(--error);">加载失败: ${e.message}</li>`
        }
      }

      async function clearPublishQueue() {
        if (!confirm('确定要清空所有待处理的发布任务吗？')) return
        try {
          const domain = `https://${apiDomain || 'api.yuangs.cc'}`
          await fetch(`${domain}/api/toutiao/queue?secret=${adminSecret}`, {
            method: 'DELETE',
          })
          fetchPublishQueueStatus()
        } catch (e) {
          alert(`清空失败: ${e.message}`)
        }
      }

      async function processPublishQueue() {
        if (!confirm('确定要立即处理队列中的所有任务吗？')) return
        try {
          const domain = `https://${apiDomain || 'api.yuangs.cc'}`
          const res = await fetch(
            `${domain}/api/toutiao/queue?secret=${adminSecret}`,
            {
              method: 'POST',
            },
          )
          if (!res.ok) throw new Error(await res.text())

          alert('队列处理已启动，请稍后刷新查看结果')
          setTimeout(() => {
            fetchPublishQueueStatus()
            fetchPublishResults()
            fetchPublishStats()
          }, 3000)
        } catch (e) {
          alert(`处理失败: ${e.message}`)
        }
      }

      async function checkPublishTaskStatus() {
        const taskId = publishCheckTaskId.value.trim()
        if (!taskId) return
        try {
          const domain = `https://${apiDomain || 'api.yuangs.cc'}`
          const res = await fetch(
            `${domain}/api/toutiao/results?id=${taskId}&secret=${adminSecret}`,
          )
          const data = await res.json()
          publishTaskStatusDisplay.textContent = JSON.stringify(data, null, 2)
        } catch (e) {
          publishTaskStatusDisplay.textContent = `查询失败: ${e.message}`
        }
      }

      async function fetchPublishStats() {
        try {
          const domain = `https://${apiDomain || 'api.yuangs.cc'}`
          const res = await fetch(
            `${domain}/api/toutiao/stats?secret=${adminSecret}`,
          )
          const data = await res.json()
          publishStatsDisplay.textContent = JSON.stringify(data, null, 2)
          
          // 更新顶部统计信息
          updateTopStats(data);
        } catch (e) {
          publishStatsDisplay.textContent = `加载失败: ${e.message}`
        }
      }
      
      function updateTopStats(statsData) {
        // 显示统计容器
        statsContainer.style.display = 'block';
        
        // 获取统计数字元素
        const totalTasksElement = document.getElementById('total-tasks-count');
        const successfulTasksElement = document.getElementById('successful-tasks-count');
        const failedTasksElement = document.getElementById('failed-tasks-count');
        
        // 更新统计数字
        if (totalTasksElement) {
          totalTasksElement.textContent = statsData.totalTasks || 0;
        }
        if (successfulTasksElement) {
          successfulTasksElement.textContent = statsData.successfulTasks || 0;
        }
        if (failedTasksElement) {
          failedTasksElement.textContent = statsData.failedTasks || 0;
        }
      }

      async function fetchPublishResults() {
        publishResultsList.innerHTML = '<li>加载中...</li>'
        try {
          const domain = `https://${apiDomain || 'api.yuangs.cc'}`
          console.log(
            'Fetching publish results from:',
            `${domain}/api/toutiao/results?secret=${adminSecret}`,
          )
          const res = await fetch(
            `${domain}/api/toutiao/results?secret=${adminSecret}`,
          )
          if (!res.ok) {
            const errorText = await res.text()
            console.error('Failed to fetch publish results:', errorText)
            throw new Error(errorText)
          }
          const data = await res.json()
          console.log('Publish results data:', data)
          publishResultsList.innerHTML = ''
          if (data && data.length > 0) {
            showLatestResult(data[0])
            data.forEach(result => {
              const li = document.createElement('li')
              const title = result.title || result.topic || '无标题'
              const isSuccess =
                result.success ||
                (result.publishResult && result.publishResult.success) ||
                result.status === 'success'
              const status = isSuccess
                ? '<span class="status-tag success">成功</span>'
                : '<span class="status-tag error">失败</span>'
              const completedAt =
                result.createdAt || result.completedAt
                  ? new Date(
                      result.createdAt || result.completedAt,
                    ).toLocaleString()
                  : 'N/A'
              
              // 添加跳转链接
              const articleUrl = result.articleUrl || result.url || (result.publishResult && result.publishResult.articleUrl);
              const titleHtml = articleUrl 
                ? `<a href="${articleUrl}" target="_blank" style="color: var(--accent); text-decoration: none;">${title}</a>`
                : `<strong>${title}</strong>`;
              
              li.innerHTML = `${status} ${titleHtml} <small>(${completedAt})</small>`
              publishResultsList.appendChild(li)
            })
          } else {
            latestResultContainer.style.display = 'none'
            publishResultsList.innerHTML = '<li>暂无历史发布结果</li>'
          }
        } catch (e) {
          console.error('Error fetching publish results:', e)
          latestResultContainer.style.display = 'none'
          publishResultsList.innerHTML = `<li style="color: var(--error);">加载失败: ${e.message}</li>`
        }
      }

      function showLatestResult(result) {
        // 如果没有结果，则隐藏容器并返回
        if (!result) {
          latestResultContainer.style.display = 'none';
          return;
        }

        // 确保容器可见
        latestResultContainer.style.display = 'block';

        // 判断任务是否成功，优先使用 result.status
        const isSuccess = result.status === 'success';

        // 根据成功或失败状态更新容器的类，从而改变样式（例如边框颜色）
        latestResultContainer.className = isSuccess
          ? 'section-box latest-result' // 成功时保留原有样式
          : 'section-box latest-result error'; // 失败时添加 error 样式

        // 显示时间，使用 createdAt 字段
        latestResultTime.textContent = result.createdAt
          ? new Date(result.createdAt).toLocaleString()
          : 'N/A';

        // 获取标题，防止为空
        const title = result.title || result.topic || '无标题';

        // 根据成功或失败状态生成对应的状态标签HTML
        const statusTagHtml = isSuccess
          ? '<span class="status-tag success">发布成功</span>'
          : '<span class="status-tag error">发布失败</span>';

        // 获取错误信息，优先使用顶层 error 字段，其次是 errorDetails.message
        const errorMsgContent = result.error || result.errorDetails?.message;
        const errorMsgHtml = errorMsgContent
          ? `<div style="color: var(--error); margin-top: 4px;">错误: ${errorMsgContent}</div>`
          : '';

        // 添加跳转链接
        const articleUrl = result.articleUrl || result.url || (result.publishResult && result.publishResult.articleUrl);
        const titleHtml = articleUrl 
          ? `<a href="${articleUrl}" target="_blank" style="color: var(--accent); text-decoration: none; font-weight: bold; font-size: 1.1em;">${title}</a>`
          : `<div style="font-weight: bold; font-size: 1.1em;">${title}</div>`;

        // 填充内容区域，确保文本换行
        latestResultContent.innerHTML = `
            ${titleHtml}
            <div><strong>状态:</strong> ${statusTagHtml}</div>
            ${errorMsgHtml}
        `;
      }
      // =================================================================
      //  User Management Functions
      // =================================================================
      async function fetchActivatedRooms() {
        activatedRoomList.innerHTML = '<li class="no-rooms">正在加载...</li>'
        const activeRooms = []
        const domain = `https://${apiDomain || 'api.yuangs.cc'}`
        const fetches = potentialRoomsToCheck.map(r =>
          fetch(`${domain}/api/room/status?roomName=${encodeURIComponent(r)}`)
            .then(res => res.json())
            .then(d => (d.active ? r : null))
            .catch(e => {
              console.error(`房间 ${r} 检查失败:`, e)
              return null
            }),
        )
        const results = await Promise.all(fetches)
        results.forEach(r => r && activeRooms.push(r))

        activatedRoomList.innerHTML = ''
        if (!activeRooms.length) {
          activatedRoomList.innerHTML =
            '<li class="no-rooms">暂无已激活的房间</li>'
        } else {
          activeRooms.forEach(r => {
            const li = document.createElement('li')
            li.textContent = r
            li.style.cursor = 'pointer'
            li.onclick = () => {
              roomNameInput.value = r
              fetchUsers()
            }
            activatedRoomList.appendChild(li)
          })
        }
      }

      async function fetchUsers() {
        const room = roomNameInput.value.trim()
        if (!room) {
          updateStatus(statusMessage, '请输入房间名！', 'error')
          return
        }
        updateStatus(statusMessage, `正在加载房间 "${room}" 的白名单…`, 'info')
        try {
          const domain = `https://${apiDomain || 'api.yuangs.cc'}`
          console.log(
            '获取用户白名单:',
            `${domain}/api/users/list?roomName=${encodeURIComponent(room)}&secret=${adminSecret}`,
          )

          const res = await fetch(
            `${domain}/api/users/list?roomName=${encodeURIComponent(room)}&secret=${adminSecret}`,
          )
          if (!res.ok) {
            const errorText = await res.text()
            console.error('获取用户列表失败:', errorText)
            throw new Error(errorText)
          }

          const data = await res.json()
          console.log('用户列表数据:', data)
          userList.innerHTML = ''

          if (!data.active) {
            userList.innerHTML = '<li>此房间尚未激活白名单功能</li>'
          } else if (!data.users || !data.users.length) {
            userList.innerHTML = '<li>此房间白名单已激活但为空</li>'
          } else {
            data.users.forEach(u => {
              const li = document.createElement('li')
              li.style.display = 'flex'
              li.style.justifyContent = 'space-between'
              li.style.alignItems = 'center'
              li.style.padding = '8px'

              const span = document.createElement('span')
              span.textContent = u
              span.style.marginRight = '10px'

              const btn = document.createElement('button')
              btn.textContent = '移除'
              btn.className = 'delete-button'
              btn.style.fontSize = '0.8em'
              btn.onclick = () => removeUser(u)

              li.append(span, btn)
              userList.appendChild(li)
            })
          }
          updateStatus(
            statusMessage,
            `房间 "${room}" 白名单已加载。`,
            'success',
          )
        } catch (e) {
          console.error('获取用户列表异常:', e)
          if (e.message.includes('404')) {
            updateStatus(
              statusMessage,
              '用户管理服务未启动，请检查后端配置',
              'error',
            )
          } else if (e.message.includes('401')) {
            updateStatus(statusMessage, '权限验证失败，请检查管理密钥', 'error')
          } else {
            updateStatus(statusMessage, `错误: ${e.message}`, 'error')
          }
        }
      }

      async function addUser() {
        const room = roomNameInput.value.trim()
        const u = newUserInput.value.trim()
        if (!room || !u)
          return updateStatus(statusMessage, '请输入房间名和用户名！', 'error')
        if (!adminSecret)
          return updateStatus(
            statusMessage,
            '无法执行操作，缺少 secret',
            'error',
          )

        addUserBtn.disabled = true
        addUserBtn.textContent = '添加中…'
        try {
          const domain = `https://${apiDomain || 'api.yuangs.cc'}`
          console.log('添加用户:', { room, username: u, secret: adminSecret })

          const res = await fetch(
            `${domain}/api/users/add?roomName=${encodeURIComponent(room)}&secret=${adminSecret}`,
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username: u }),
            },
          )

          if (!res.ok) {
            const errorText = await res.text()
            console.error('添加用户失败:', errorText)
            throw new Error(errorText)
          }

          newUserInput.value = ''
          await fetchUsers()
          await fetchActivatedRooms()
          updateStatus(statusMessage, `成功添加用户: ${u}`, 'success')
        } catch (e) {
          console.error('添加用户异常:', e)
          if (e.message.includes('404')) {
            updateStatus(
              statusMessage,
              '用户管理服务未启动，请检查后端配置',
              'error',
            )
          } else if (e.message.includes('401')) {
            updateStatus(statusMessage, '权限验证失败，请检查管理密钥', 'error')
          } else if (e.message.includes('409')) {
            updateStatus(statusMessage, `用户 ${u} 已存在于白名单中`, 'error')
          } else {
            updateStatus(statusMessage, `添加失败: ${e.message}`, 'error')
          }
        } finally {
          addUserBtn.disabled = false
          addUserBtn.textContent = '添加'
        }
      }

      async function removeUser(u) {
        const room = roomNameInput.value.trim()
        if (!room || !adminSecret)
          return updateStatus(statusMessage, '缺少 room 或 secret', 'error')
        if (!confirm(`确认移除 "${u}"？`)) return

        try {
          const domain = `https://${apiDomain || 'api.yuangs.cc'}`
          console.log('移除用户:', { room, username: u, secret: adminSecret })

          const res = await fetch(
            `${domain}/api/users/remove?roomName=${encodeURIComponent(room)}&secret=${adminSecret}`,
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username: u }),
            },
          )

          if (!res.ok) {
            const errorText = await res.text()
            console.error('移除用户失败:', errorText)
            throw new Error(errorText)
          }

          await fetchUsers()
          updateStatus(statusMessage, `成功移除用户: ${u}`, 'success')
        } catch (e) {
          console.error('移除用户异常:', e)
          if (e.message.includes('404')) {
            updateStatus(
              statusMessage,
              '用户管理服务未启动，请检查后端配置',
              'error',
            )
          } else if (e.message.includes('401')) {
            updateStatus(statusMessage, '权限验证失败，请检查管理密钥', 'error')
          } else if (e.message.includes('404')) {
            updateStatus(statusMessage, `用户 ${u} 不存在于白名单中`, 'error')
          } else {
            updateStatus(statusMessage, `移除失败: ${e.message}`, 'error')
          }
        }
      }

      // =================================================================
      //  Event Listeners & Initial Load
      // =================================================================
      document.addEventListener('DOMContentLoaded', () => {
        if (!adminSecret) {
          document.body.innerHTML =
            '<h1>未授权访问</h1><p>请在URL中提供正确的管理密钥 (?secret=您的密钥)。</p>'
          return
        }
        initTheme()
        populateRoomSelects()
        switchTab('inspiration-management') // Default to inspiration tab

        // 预加载发布管理相关数据
        fetchPublishStats()
        fetchPublishResults()
        fetchPublishQueueStatus()

        // Bind user management events
        loadUsersBtn.onclick = fetchUsers
        addUserBtn.onclick = addUser

        // 为知乎灵感输入框添加事件监听器
        const inspirationInput = document.getElementById(
          'inspiration-topic-input',
        )
        const inspirationClearBtn =
          inspirationInput?.parentElement?.querySelector('.input-clear-btn')

        if (inspirationInput && inspirationClearBtn) {
          // 初始化清除按钮状态
          inspirationClearBtn.style.display = inspirationInput.value
            ? 'flex'
            : 'none'

          // 输入时显示/隐藏清除按钮
          inspirationInput.addEventListener('input', function () {
            inspirationClearBtn.style.display = this.value ? 'flex' : 'none'
          })

          // 粘贴时显示/隐藏清除按钮
          inspirationInput.addEventListener('paste', function () {
            setTimeout(() => {
              inspirationClearBtn.style.display = this.value ? 'flex' : 'none'
            }, 10)
          })
        }
        
        // 为新闻输入框添加事件监听器
        const newsInput = document.getElementById('news-topic-input')
        const newsClearBtn = 
          newsInput?.parentElement?.querySelector('.input-clear-btn')
          
        if (newsInput && newsClearBtn) {
          // 初始化清除按钮状态
          newsClearBtn.style.display = newsInput.value
            ? 'flex'
            : 'none'

          // 输入时显示/隐藏清除按钮
          newsInput.addEventListener('input', function () {
            newsClearBtn.style.display = this.value ? 'flex' : 'none'
          })

          // 粘贴时显示/隐藏清除按钮
          newsInput.addEventListener('paste', function () {
            setTimeout(() => {
              newsClearBtn.style.display = this.value ? 'flex' : 'none'
            }, 10)
          })
        }
      })
    </script>
  </body>
</html>
